<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="https://media.ao.com/cdnbundle/aost/3.1.1008.0/bundled/AOL/css/MasterStructure.css">
	<style type="text/css">
		.preview-controls h1 {
			font-size: 30px;
	    	font-family: ozReg, Arial, Helvetica, sans-serif;
	    	margin-top: 20px;
	    	text-align: center;
		}	

		.preview-controls label {
			font-size: 16px;
		}	
		#preview-pane {
			width: 768px;
			margin: auto;
		}

		#preview-pane h1 {
	    	text-align: center;
	    	font-size: 30px;
	    	font-family: ozReg, Arial, Helvetica, sans-serif;
	    }

	</style>
	<style type="text/css" id="lister-content-styles">

		#lister-seo-content {
			background-color: #f4f4f5;
			color: #000;
			width: 768px;
			display: inline-block;
		}

		#lister-seo-content * {
			box-sizing: border-box;
		}

		#lister-seo-content .panel {
			width: 33.333333%;
			padding: 10px;
			display: table-cell;
			vertical-align: top;
		}

		#lister-seo-content p, #lister-seo-content a {
			font-size: 12px;
			font-family: Arial, Helvetica, sans-serif;
		}

		#lister-seo-content h3 {
			font-size: 16px;
			font-weight: bold;
			font-family: ozReg, Arial, Helvetica, sans-serif;
		}

		#lister-seo-content .bkground-img {
			background-repeat: no-repeat;
			background-position: 100% 100%;
		}

		#lister-seo-content .bg-one {
			background-image: url('http://media.ao.com/uk/listerSeoBlocks/MachineRecycleImage.png');
		}

		#lister-seo-content .bg-two {
			background-image: url('http://media.ao.com/uk/listerSeoBlocks/MicrowaveInstallimage.png');
		}

	</style>
</head>
<body>

	<section class="container preview-controls">
		<div class="row">
			<div class="col-sm-12">
				<h1>Editor</h1>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-4">
				<h2>Block 1</h2>
				<form id="block-one">
					<fieldset class="form-group">
						<label for="bkimg-one">Background image 1</label>
						<input type="text" class="form-control bkimg" id="bkimg-one" placeholder="block 1 background image">
					</fieldset>
					<fieldset class="form-group">
						<label for="titleblock-one">Title block 1</label>
						<input type="text" class="form-control titleblock" id="titleblock-one" placeholder="Title for block 1">
					</fieldset>
					<fieldset class="form-group">
						<label for="p1block-one">Paragraph 1 block 1</label>
						<textarea class="form-control p1block" id="p1block-one" rows="3" placeholder="Paragraph 1 for block 1"></textarea>
					</fieldset>
				</form>
			</div>
			<div class="col-sm-4">
				<h2>Block 2</h2>
				<form id="block-two">
					<fieldset class="form-group">
						<label for="bkimg-two">Background image 2</label>
						<input type="text" class="form-control bkimg" id="bkimg-two" placeholder="block 2 background image">
					</fieldset>
					<fieldset class="form-group">
						<label for="titleblock-two">Title block 2</label>
						<input type="text" class="form-control titleblock" id="titleblock-two" placeholder="Title for block 2">
					</fieldset>
					<fieldset class="form-group">
						<label for="p1block-two">Paragraph 1 block 2</label>
						<textarea class="form-control p1block" id="p1block-two" rows="3" placeholder="Paragraph 1 for block 2"></textarea>
					</fieldset>
				</form>
			</div>
			<div class="col-sm-4">
				<h2>Block 3</h2>
				<form id="block-three">
					<fieldset class="form-group">
						<label for="bkimg-three">Background image 3</label>
						<input type="text" class="form-control bkimg" id="bkimg-three" placeholder="block 3 background image">
					</fieldset>
					<fieldset class="form-group">
						<label for="titleblock-three">Title block 3</label>
						<input type="text" class="form-control titleblock" id="titleblock-three" placeholder="Title for block 3">
					</fieldset>
					<fieldset class="form-group">
						<label for="p1block-three">Paragraph 1 block 3</label>
						<textarea class="form-control p1block" id="p1block-three" rows="3" placeholder="Paragraph 1 for block 3"></textarea>
					</fieldset>
				</form>
			</div>
		</div>		
	</section>
	<section id="preview-pane">
		<h1>Preview</h1>
		<div id="lister-seo-content">
	        <div class="panel panel-one">
	            <h3>Find the right appliance</h3>
	            <p class="p1">Read our <a href="/help-and-advice/buying-guide/washing-machines">Buying Guide</a>
	            and discover the top 5 features to look out for when buying a new
	            washing machine.</p>
	            <p class="p2">Read our <a href="/help-and-advice/buying-guide/washing-machines">Buying Guide</a></p>
	        </div><div class="panel panel-two">
	            <h3>Top 5 washing machines</h3>
	            <p class="p1">We've handpicked a selection of washing machines that offer the very best in quality and value.</p>
	            <p class="p2"><a href="/best/washing-machines">Shop our Best Buy washing machines</a></p>
	        </div><div class="panel panel-three">
	            <h3>Choose our installation &amp; recycling services</h3>
	            <p class="p1">View <a href="/help-and-advice/Help-With-My-Order/laundry-installation">Installation</a></p>
	            <p class="p2">View <a href="/help-and-advice/Help-With-My-Order/Recycling-and-Disconnection">Recycling</a></p>
	        </div>
	    </div>
	</section>

	<script type="text/javascript">

		function addEvent(el, evt, fn) {
			el.addEventListener(evt, fn, false);
		}

		function getPanel(className) {
			return panels.filter(panel => panel.classList.contains(className)).pop();
		}

		function getBlockClass(input) {
			return `panel${input.id.match(/\-.*$/)[0]}`;
		}

		var panels = Array.from(document.querySelectorAll(".panel"));
		
		(function() {		

			/*	Background image */	

			function addBackgroundImage(event) {
				setTimeout(() => {
					let input = event.target;
					let path = input.value;
					let blockClass = getBlockClass(input);
					let block = getPanel(blockClass);
					if(path) {
						let tryToLoadImage = imageExists(path);
						tryToLoadImage.then(function(exists) {
							if(exists) {
								setBackgroundImage(block, path);
								setBackgroundClass(block);
							}
							else {
								removeBackgroundImage(block);
								removeBackgroundClass(block);
							}
						});	
					}	
					else {
						removeBackgroundImage(block);
						removeBackgroundClass(block);
					}													
				}, 0);				
			}

			function imageExists(path) {
				return new Promise(function(res, rej) {
					var img = new Image();
					function onLoad() {
						removeListeners();
						res(true);
					}
					function onError(e) {
						removeListeners();
						res(false);
					}
					function removeListeners() {
						img.removeEventListener("load", onLoad);
						img.removeEventListener("error", onError);
					}
					img.addEventListener("load", onLoad);
					img.addEventListener("error", onError);
					img.src = path;
				});
				
			}

			function setBackgroundClass(target) {
				target.classList.add("bkground-img");
			}

			function removeBackgroundClass(target) {
				target.classList.remove("bkground-img");
			}

			function setBackgroundImage(target, path) {
				target.style.backgroundImage = `url('${path}')`;
			}

			function removeBackgroundImage(target) {
				target.style.backgroundImage = "";
			}			

			var bkimgInputs = Array.from(document.querySelectorAll(".bkimg"));

			bkimgInputs.forEach(input => { 
				addEvent(input, "keyup", addBackgroundImage); 
				addEvent(input, "cut", addBackgroundImage); 
				addEvent(input, "paste", addBackgroundImage); 
			});

		})();

		(function() {

			/* titles */

			var titleblockInputs = Array.from(document.querySelectorAll(".titleblock"));

			titleblockInputs.forEach(input => { 
				addEvent(input, "keyup", addTitle); 
				addEvent(input, "cut", addTitle); 
				addEvent(input, "paste", addTitle); 
			});

			function updateTitle(target, title) {
				getTitle(target).innerText = title;
			}

			function getTitle(target) {
				return target.querySelector("h3");
			}

			function addTitle(event) {
				setTimeout(() => {
					let input = event.target;
					let title = input.value;
					let blockClass = getBlockClass(input);
					let block = getPanel(blockClass);
					updateTitle(block, title);
				}, 0);
			}

		})();

		(function() {

			/* paragraph 1 */

			var p1blockInputs = Array.from(document.querySelectorAll(".p1block"));

			p1blockInputs.forEach(input => { 
				addEvent(input, "keyup", addP1); 
				addEvent(input, "cut", addP1); 
				addEvent(input, "paste", addP1); 
			});

			function updateP1(target, title) {
				getP1(target).innerText = title;
			}

			function getP1(target) {
				return target.querySelector(".p1");
			}

			function getInputWithSelectedText(text) {
				return p1blockInputs.filter(input => input.value === text).pop();
			}

			function addP1(event) {
				setTimeout(() => {
					let input = event.target;
					let title = input.value;
					let blockClass = getBlockClass(input);
					let block = getPanel(blockClass);
					updateP1(block, title);
				}, 0);
			}

		})();

		(function() {

			/* add a tags */

			var p1s = Array.from(document.querySelectorAll(".p1"));

			p1s.forEach(p1 => { 
				addEvent(p1, "mouseup", addATag); 
			});

			function clearSelectedText() {
				selectedText = "";
			}

			function addATag(event) {
				let p = event.target;
				let selectedText = window.getSelection().toString();
				if(selectedText) {
					let anchorText = prompt("Enter a link for this text");
					if(anchorText) {
						createLink(anchorText, selectedText, p);
					}		
				}														
			}

			function createLink(anchorText, selectedText, p) {
				let link = insertLink(anchorText, selectedText);
				p.innerHTML = p.innerHTML.replace(selectedText, link);
			}

			function insertLink(anchorText, selectedText) {
				return `<a href="${anchorText}" target="_blank">${selectedText}</a>`;
			}

		})();

		(function(){

			panels.forEach(panel => addEvent(panel, "click", onATagClick));

			function getLink(anchorText, selectedText) {
				return `<a href="${anchorText}" target="_blank">${selectedText}</a>`;
			}

			function onATagClick(evt) {
				evt.preventDefault();
				let target = evt.target;
				if(target.tagName === "A" && target.parentNode.classList.contains("p1")) {
					let removeATag = confirm("Click yes to remove this link, cancel to go to link URL");
					if(removeATag) {
						let linkText = target.innerText;
						let linkhref = target.href;
						let aParent = target.parentNode;
						let aTags = Array.from(aParent.querySelectorAll("a"));
						aTags.forEach(a => {
							if(a.innerText === linkText) {
								let indexOfATag = aParent.innerHTML.indexOf(a.outerHTML);
								aParent.removeChild(a);
								let parentHTML = aParent.innerHTML.substr(0, indexOfATag) + 
									linkText + 
									aParent.innerHTML.substr(indexOfATag, aParent.innerHTML.length);
								aParent.innerHTML = parentHTML;
							}
						});
					}
					else {
						window.location = target.href;
					}
				}
			}

		})();
		
	</script>

</body>
</html>